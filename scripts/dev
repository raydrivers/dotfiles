#!/bin/bash
LOGFILE=".dev.log"
WARN_FLAG=""

while getopts "w" opt; do
    case $opt in
        w) WARN_FLAG="-w" ;;
    esac
done
shift $((OPTIND - 1))

for script in ./dev ./dev.sh ./.dev; do
    if [[ -x "$script" ]]; then
        "$script" "$@" 2>&1 | tee "$LOGFILE"
        exit_code=${PIPESTATUS[0]}

        if [[ $exit_code -ne 0 ]]; then
            echo ""
            echo "Failed with exit code $exit_code. Opening editor for resolution..."
            dev-parse $WARN_FLAG "$LOGFILE" > "$LOGFILE.qf"
            first_file=$(head -1 "$LOGFILE.qf" | cut -d: -f1)
            first_line=$(head -1 "$LOGFILE.qf" | cut -d: -f2)
            nvim "$first_file" "+$first_line" -c "cgetfile $LOGFILE.qf" -c "copen" -c "wincmd p"
        fi
        exit $exit_code
    fi
done

echo "No dev script found (tried: ./dev, ./dev.sh, ./.dev)"
exit 1
